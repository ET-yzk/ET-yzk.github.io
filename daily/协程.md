# åç¨‹

[TOC]

> **åç¨‹ï¼Œè‹±æ–‡Coroutinesï¼Œæ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å­˜åœ¨ã€‚**æ­£å¦‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹ä¸€æ ·ï¼Œä¸€ä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥æ‹¥æœ‰å¤šä¸ªåç¨‹ã€‚

## ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹

**è¿›ç¨‹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ**

ç›´ç™½åœ°è®²ï¼Œè¿›ç¨‹å°±æ˜¯åº”ç”¨ç¨‹åºçš„å¯åŠ¨å®ä¾‹ã€‚æ¯”å¦‚æˆ‘ä»¬è¿è¡Œä¸€ä¸ªæ¸¸æˆï¼Œæ‰“å¼€ä¸€ä¸ªè½¯ä»¶ï¼Œå°±æ˜¯å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚

è¿›ç¨‹æ‹¥æœ‰ä»£ç å’Œæ‰“å¼€çš„æ–‡ä»¶èµ„æºã€æ•°æ®èµ„æºã€ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€‚

**çº¿ç¨‹åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ**

çº¿ç¨‹ä»å±äºè¿›ç¨‹ï¼Œæ˜¯ç¨‹åºçš„å®é™…æ‰§è¡Œè€…ã€‚ä¸€ä¸ªè¿›ç¨‹è‡³å°‘åŒ…å«ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æœ‰æ›´å¤šçš„å­çº¿ç¨‹ã€‚

çº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ã€‚

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241608412.jpeg)

æœ‰äººç»™å‡ºäº†å¾ˆå¥½çš„å½’çº³ï¼š

**å¯¹æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œçº¿ç¨‹æ˜¯æœ€å°çš„æ‰§è¡Œå•å…ƒï¼Œè¿›ç¨‹æ˜¯æœ€å°çš„èµ„æºç®¡ç†å•å…ƒã€‚**

æ— è®ºè¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œéƒ½æ˜¯ç”±**æ“ä½œç³»ç»Ÿ**æ‰€ç®¡ç†çš„ã€‚

Javaä¸­çº¿ç¨‹å…·æœ‰äº”ç§çŠ¶æ€ï¼š

**åˆå§‹åŒ–**ã€**å¯è¿è¡Œ**ã€**è¿è¡Œä¸­**ã€**é˜»å¡**ã€**é”€æ¯**

è¿™äº”ç§çŠ¶æ€çš„è½¬åŒ–å…³ç³»å¦‚ä¸‹ï¼š

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241612974.png)

ä½†æ˜¯ï¼Œçº¿ç¨‹ä¸åŒçŠ¶æ€ä¹‹é—´çš„è½¬åŒ–æ˜¯è°æ¥å®ç°çš„å‘¢ï¼Ÿæ˜¯JVMå—ï¼Ÿ

å¹¶ä¸æ˜¯ã€‚JVMéœ€è¦é€šè¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„TCBï¼ˆThread Control Blockï¼‰æ¨¡å—æ¥æ”¹å˜çº¿ç¨‹çš„çŠ¶æ€ï¼Œè¿™ä¸€è¿‡ç¨‹éœ€è¦è€—è´¹ä¸€å®šçš„CPUèµ„æºã€‚

## è¿›ç¨‹å’Œçº¿ç¨‹çš„ç—›ç‚¹

çº¿ç¨‹ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œåä½œçš„å‘¢ï¼Ÿ

æœ€ç»å…¸çš„ä¾‹å­å°±æ˜¯**ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼**ï¼š

è‹¥å¹²ä¸ªç”Ÿäº§è€…çº¿ç¨‹å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®ï¼Œè‹¥å¹²ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ•°æ®ã€‚

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241613133.png)

å¦‚ä½•ç”¨javaè¯­è¨€å®ç°ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼å‘¢ï¼Ÿ

è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä»£ç ï¼š

```java
public class ProducerConsumerTest {

	public static void main(String args[]) {
		final Queue<Integer> sharedQueue = new Queue();
		Thread producer = new Producer(sharedQueue);
		Thread consumer = new Consumer(sharedQueue);
		producer.start();
		consumer.start();
	}
}

class Producer extends Thread {

	private static final int MAX_QUEUE_SIZE = 5;
	private final Queue sharedQueue;
    
	public Producer(Queue sharedQueue) {
		super();
		this.sharedQueue = sharedQueue;
	}

	@Override
	public void run() {
		for (int i = 0; i < 100; i++) {
			synchronized (sharedQueue) {
				while (sharedQueue.size() >= MAX_QUEUE_SIZE) {
					System.out.println("é˜Ÿåˆ—æ»¡äº†ï¼Œç­‰å¾…æ¶ˆè´¹");

					try {
						sharedQueue.wait();
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
                
				sharedQueue.add(i);
				System.out.println("è¿›è¡Œç”Ÿäº§ : " + i);
				sharedQueue.notify();
			}
		}
	}
}

class Consumer extends Thread {

	private final Queue sharedQueue;

	public Consumer(Queue sharedQueue) {
		super();
		this.sharedQueue = sharedQueue;
	}

	@Override
	public void run() {
		while (true) {
			synchronized (sharedQueue) {
				while (sharedQueue.size() == 0) {
					try {
						System.out.println("é˜Ÿåˆ—ç©ºäº†ï¼Œç­‰å¾…ç”Ÿäº§");
						sharedQueue.wait();
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
				int number = sharedQueue.poll();
				System.out.println("è¿›è¡Œæ¶ˆè´¹ : " + number);
				sharedQueue.notify();
			}
		}
	}
}
```

è¿™æ®µä»£ç åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š

1. å®šä¹‰äº†ä¸€ä¸ªç”Ÿäº§è€…ç±»ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ç±»ã€‚

2. ç”Ÿäº§è€…ç±»å¾ªç¯100æ¬¡ï¼Œå‘åŒæ­¥é˜Ÿåˆ—å½“ä¸­æ’å…¥æ•°æ®ã€‚

3. æ¶ˆè´¹è€…å¾ªç¯ç›‘å¬åŒæ­¥é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—æœ‰æ•°æ®æ—¶æ‹‰å–æ•°æ®ã€‚

4. å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼ˆè¾¾åˆ°5ä¸ªå…ƒç´ ï¼‰ï¼Œç”Ÿäº§è€…é˜»å¡ã€‚

5. å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œæ¶ˆè´¹è€…é˜»å¡ã€‚

ä¸Šé¢çš„ä»£ç æ­£ç¡®åœ°å®ç°äº†ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼ï¼Œä½†æ˜¯å´å¹¶ä¸æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å®ç°ã€‚ä¸ºä»€ä¹ˆæ€§èƒ½ä¸é«˜å‘¢ï¼ŸåŸå› å¦‚ä¸‹ï¼š

1. æ¶‰åŠåˆ°åŒæ­¥é”ã€‚

2. æ¶‰åŠåˆ°çº¿ç¨‹é˜»å¡çŠ¶æ€å’Œå¯è¿è¡ŒçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢ã€‚

3. æ¶‰åŠåˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚

ä»¥ä¸Šæ¶‰åŠåˆ°çš„ä»»ä½•ä¸€ç‚¹ï¼Œéƒ½æ˜¯éå¸¸è€—è´¹æ€§èƒ½çš„æ“ä½œã€‚

## åç¨‹çš„ä¼˜åŠ¿

**ä»€ä¹ˆæ˜¯åç¨‹**

**åç¨‹ä¸æ˜¯è¢«æ“ä½œç³»ç»Ÿå†…æ ¸æ‰€ç®¡ç†ï¼Œè€Œå®Œå…¨æ˜¯ç”±ç¨‹åºæ‰€æ§åˆ¶ï¼ˆä¹Ÿå°±æ˜¯åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼‰ã€‚**

è¿™æ ·å¸¦æ¥çš„å¥½å¤„å°±æ˜¯æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§çš„æå‡ï¼Œä¸ä¼šåƒçº¿ç¨‹åˆ‡æ¢é‚£æ ·æ¶ˆè€—èµ„æºã€‚

åç¨‹ä¸è¿›ç¨‹ã€çº¿ç¨‹ç›¸æ¯”ä¸æ˜¯ä¸€ä¸ªç»´åº¦çš„æ¦‚å¿µï¼Œä½†æ˜¯æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å°†å®ƒä»¬åšä¸€ç•ªæ¯”è¾ƒï¼Œå…·ä½“å¦‚ä¸‹ï¼š

1. åç¨‹æ—¢ä¸æ˜¯è¿›ç¨‹ï¼Œä¹Ÿä¸æ˜¯çº¿ç¨‹ï¼Œåç¨‹ä»…ä»…æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œåç¨‹è·Ÿä»–ä»¬å°±ä¸æ˜¯ä¸€ä¸ªç»´åº¦ã€‚

2. ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªåç¨‹ã€‚

3. ä¸€ä¸ªçº¿ç¨‹å†…çš„å¤šä¸ªåç¨‹è™½ç„¶å¯ä»¥åˆ‡æ¢ï¼Œä½†æ˜¯è¿™å¤šä¸ªåç¨‹æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œåªèƒ½åœ¨è¿™ä¸€ä¸ªçº¿ç¨‹å†…è¿è¡Œï¼Œæ²¡æ³•åˆ©ç”¨CPUå¤šæ ¸èƒ½åŠ›ã€‚

4 åç¨‹ä¸è¿›ç¨‹ã€çº¿ç¨‹ä¸€æ ·ï¼Œå®ƒä»¬çš„åˆ‡æ¢éƒ½å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜ã€‚

è¡¨é¢ä¸Šï¼Œè¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹éƒ½å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸‰è€…ä¸Šä¸‹æ–‡åˆ‡æ¢åˆæœ‰æ˜æ˜¾ä¸åŒï¼Œè§ä¸‹è¡¨ï¼š

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241622875.png)

## åç¨‹çš„ä½¿ç”¨åœºæ™¯

**ä¸€ä¸ªçº¿ç¨‹å†…çš„å¤šä¸ªåç¨‹æ˜¯ä¸²è¡Œæ‰§è¡Œçš„**ï¼Œä¸èƒ½åˆ©ç”¨å¤šæ ¸ï¼Œæ‰€ä»¥ï¼Œæ˜¾ç„¶ï¼Œåç¨‹ä¸é€‚åˆè®¡ç®—å¯†é›†å‹çš„åœºæ™¯ã€‚**åç¨‹é€‚åˆI/O é˜»å¡å‹ã€‚**

I/Oæœ¬èº«å°±æ˜¯é˜»å¡å‹çš„ï¼ˆç›¸è¾ƒäºCPUçš„æ—¶é—´ä¸–ç•Œè€Œè¨€ï¼‰ã€‚å°±ç›®å‰è€Œè¨€ï¼Œæ— è®ºI/Oçš„é€Ÿåº¦å¤šå¿«ï¼Œä¹Ÿæ¯”ä¸ä¸ŠCPUçš„é€Ÿåº¦ï¼Œæ‰€ä»¥ä¸€ä¸ªI/Oç›¸å…³çš„ç¨‹åºï¼Œå½“å…¶åœ¨è¿›è¡ŒI/Oæ“ä½œæ—¶å€™ï¼ŒCPUå®é™…ä¸Šæ˜¯ç©ºé—²çš„ã€‚

æˆ‘ä»¬å‡è®¾è¿™æ ·çš„åœºæ™¯ï¼Œå¦‚ä¸‹å›¾ï¼š1ä¸ªçº¿ç¨‹æœ‰5ä¸ªI/Oçš„äº‹æƒ…ï¼ˆå­ç¨‹åºï¼‰è¦å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬ç»å¯¹çš„ä¸²è¡ŒåŒ–ï¼Œé‚£ä¹ˆå½“å…¶ä¸­ä¸€ä¸ªI/Oé˜»å¡æ—¶ï¼Œå…¶ä»–4ä¸ªI/Oå¹¶ä¸èƒ½å¾—åˆ°æ‰§è¡Œï¼Œå› ä¸ºç¨‹åºæ˜¯ç»å¯¹ä¸²è¡Œçš„ï¼Œ5ä¸ªI/Oå¿…é¡»ä¸€ä¸ªä¸€ä¸ªæ’é˜Ÿç­‰å¾…å¤„ç†ï¼Œå½“ä¸€ä¸ªI/Oé˜»å¡æ—¶ï¼Œå…¶å®ƒ4ä¸ªä¹Ÿå¾—ç­‰ç€ã€‚

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241624748.png)

è€Œåç¨‹èƒ½æ¯”è¾ƒå¥½åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œå½“ä¸€ä¸ªåç¨‹ï¼ˆç‰¹æ®Šå­è¿›ç¨‹ï¼‰é˜»å¡æ—¶ï¼Œå®ƒå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–æ²¡æœ‰é˜»å¡çš„åç¨‹ä¸Šå»ç»§ç»­æ‰§è¡Œï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°æ¯”è¾ƒé«˜çš„æ•ˆç‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241624875.png)

ä¸Šé¢ä¸¾çš„ä¾‹å­æ˜¯5ä¸ªI/Oå¤„ç†ï¼Œå¦‚æœæ¯ç§’500ä¸ªï¼Œ5ä¸‡ä¸ªæˆ–500ä¸‡ä¸ªå‘¢ï¼Ÿå·²ç»è¾¾åˆ°äº†â€œI/Oå¯†é›†å‹â€çš„ç¨‹åº¦ï¼Œè€Œ**â€œI/Oå¯†é›†å‹â€ç¡®å®æ˜¯åç¨‹æ— æ³•åº”ä»˜çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰åˆ©ç”¨å¤šæ ¸çš„èƒ½åŠ›ã€‚è¿™ä¸ªæ—¶å€™çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯â€œå¤šè¿›ç¨‹+åç¨‹â€äº†ã€‚**

æ‰€ä»¥è¯´ï¼ŒI/Oé˜»å¡æ—¶ï¼Œåˆ©ç”¨åç¨‹æ¥å¤„ç†ç¡®å®æœ‰ä¼˜ç‚¹ï¼ˆåˆ‡æ¢æ•ˆç‡æ¯”è¾ƒé«˜ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿéœ€è¦çœ‹åˆ°å…¶ä¸èƒ½åˆ©ç”¨å¤šæ ¸çš„è¿™ä¸ªç¼ºç‚¹ï¼Œå¿…è¦çš„æ—¶å€™ï¼Œè¿˜éœ€è¦ä½¿ç”¨ç»¼åˆæ–¹æ¡ˆï¼šå¤šè¿›ç¨‹+åç¨‹ã€‚

---

# [Kotlin Jetpack å®æˆ˜ï¼šå›¾è§£åç¨‹åŸç†](https://mp.weixin.qq.com/s/7nAs1T4hh_lGpEEEYjTVDg)

> ä»¥ä¸‹æ–‡ç« æ¥æºäºæœ±æ¶›çš„è‡ªä¹ å®¤ ï¼Œä½œè€…[æœ±æ¶›](https://mp.weixin.qq.com/s/7nAs1T4hh_lGpEEEYjTVDg#)

## å‰è¨€

åç¨‹(Coroutines)ï¼Œæ˜¯ Kotlin **ã€Œæœ€ç¥å¥‡ã€**çš„ç‰¹æ€§ï¼Œæ²¡æœ‰ä¹‹ä¸€ã€‚

æœ¬æ–‡ä¼šä»¥`å›¾è§£ + åŠ¨ç”»`çš„å½¢å¼è§£é‡Š Kotlin åç¨‹çš„åŸç†ã€‚çœ‹å®Œæœ¬æ–‡åï¼Œä½ ä¼šå‘ç°ï¼ŒåŸæ¥åç¨‹ä¹Ÿæ²¡æœ‰é‚£ä¹ˆéš¾ã€‚

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630647.gif)

æœ¬æ–‡è¦æ±‚è¯»è€…æœ‰ä¸€å®šçš„ Kotlin åŸºç¡€ï¼Œæ¬¢è¿é˜…è¯»ã€ŠKotlin Jetpack å®æˆ˜ã€‹å…¶ä»–æ–‡ç« ã€‚

## 1. ä¸€è¾¹çœ‹æ–‡ç« ï¼Œä¸€è¾¹è·‘ Demo



æœ¬æ–‡çš„ Demo[^1]



## 2. çº¿ç¨‹ & åç¨‹

å¾ˆå¤šä¸»æµç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒåç¨‹ï¼Œæ¯”å¦‚ï¼šC#ï¼ŒPythonï¼ŒLuaï¼Œå°±è¿`C++20`éƒ½å¼€å§‹ä¹Ÿæ”¯æŒåç¨‹äº†ã€‚ç†è§£äº† Kotlin çš„åç¨‹ä»¥åï¼Œä½ ä¼šæƒŠå–œçš„å‘ç°å…¶ä»–è¯­è¨€é‡Œçš„åç¨‹ä¹Ÿå¾ˆå®¹æ˜“ç†è§£äº†ã€‚

æœ‰çš„äººä¼šå°†åç¨‹æ¯”å–»æˆï¼šçº¿ç¨‹çš„å°è£…æ¡†æ¶ï¼Œä»å®è§‚è§’åº¦æ˜¯å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä½† Kotlin å®˜æ–¹æœ€å–œæ¬¢è¯´ï¼šåç¨‹æœ‰ç‚¹åƒ`è½»é‡çº§çš„çº¿ç¨‹`ã€‚

åç¨‹èƒ½è½»é‡åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿå°±ç®—ä½ åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åˆ›å»º`1000`ä¸ªåç¨‹ï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630192.webp)

**ã€Œä»åŒ…å«å…³ç³»ä¸Šçœ‹ï¼Œåç¨‹è·Ÿçº¿ç¨‹çš„å…³ç³»ï¼Œæœ‰ç‚¹åƒâ€œçº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»â€ï¼Œæ¯•ç«Ÿï¼Œåç¨‹ä¸å¯èƒ½è„±ç¦»çº¿ç¨‹è¿è¡Œã€‚ã€**

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630028.webp)

åç¨‹è™½ç„¶ä¸èƒ½è„±ç¦»çº¿ç¨‹è€Œè¿è¡Œï¼Œä½†å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´åˆ‡æ¢ã€‚çœ‹åˆ°è¿™ï¼Œå¤§å®¶åº”è¯¥èƒ½ç†è§£æœ¬æ–‡æœ€å¼€å§‹æ”¾çš„é‚£å¼ åŠ¨å›¾çš„å«ä¹‰äº†å§ï¼Ÿ

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630647.gif)

è¯´äº†è¿™ä¹ˆå¤šåç¨‹çš„å¥½ï¼Œä½†å°±å‡­å®ƒçš„â€é«˜æ•ˆâ€œï¼Œâ€è½»é‡â€œæˆ‘ä»¬å°±è¦ç”¨å—ï¼Ÿæ±‡ç¼–è¯­è¨€ä¹Ÿå¾ˆé«˜æ•ˆå•Šã€‚C è¯­è¨€ä¹Ÿèƒ½å†™å‡ºè½»é‡çš„ç¨‹åºå•Šã€‚

é«˜æ•ˆå’Œè½»é‡ï¼Œéƒ½ä¸æ˜¯ Kotlin åç¨‹çš„æ ¸å¿ƒç«äº‰åŠ›ã€‚

**ã€ŒKotlin åç¨‹çš„æ ¸å¿ƒç«äº‰åŠ›åœ¨äºï¼šå®ƒèƒ½ç®€åŒ–`å¼‚æ­¥å¹¶å‘`ä»»åŠ¡ã€‚ã€**

ä½œä¸º Java å¼€å‘è€…ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ¥š`çº¿ç¨‹å¹¶å‘`æ˜¯å¤šä¹ˆçš„å±é™©ï¼Œå†™å‡ºæ¥çš„å¼‚æ­¥ä»£ç æ˜¯å¤šä¹ˆçš„éš¾ä»¥ç»´æŠ¤ã€‚

## 3. å¼‚æ­¥ä»£ç  & å›è°ƒåœ°ç‹±

ä»¥ä¸€æ®µç®€å•çš„ Java ä»£ç ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œä»æœåŠ¡ç«¯æŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯ï¼Œé€šè¿‡ CallBack è¿”å› responseï¼š

```java
getUserInfo(new CallBack() {
    @Override
    public void onSuccess(String response) {
        if (response != null) {
            System.out.println(response);
        }
    }
});
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¦‚æœæˆ‘ä»¬çš„éœ€æ±‚å˜æˆäº†è¿™æ ·å‘¢ï¼Ÿ

æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ --> æŸ¥æ‰¾è¯¥ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ -->æ‹¿åˆ°å¥½å‹åˆ—è¡¨åï¼ŒæŸ¥æ‰¾è¯¥å¥½å‹çš„åŠ¨æ€

```java
getUserInfo(new CallBack() {
    @Override
    public void onSuccess(String user) {
        if (user != null) {
            System.out.println(user);
            getFriendList(user, new CallBack() {
                @Override
                public void onSuccess(String friendList) {
                    if (friendList != null) {
                        System.out.println(friendList);
                        getFeedList(friendList, new CallBack() {
                            @Override
                            public void onSuccess(String feed) {
                                if (feed != null) {
                                    System.out.println(feed);
                                }
                            }
                        });
                    }
                }
            });
        }
    }
});
```

æœ‰ç‚¹æ¶å¿ƒäº†ï¼Œæ˜¯ä¸æ˜¯ï¼Ÿè¿™è¿˜æ˜¯ä»…åŒ…å« onSuccess çš„æƒ…å†µï¼Œå®é™…æƒ…å†µä¼šæ›´å¤æ‚ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜è¦å¤„ç†å¼‚å¸¸ï¼Œå¤„ç†é‡è¯•ï¼Œå¤„ç†çº¿ç¨‹è°ƒåº¦ï¼Œç”šè‡³è¿˜å¯èƒ½æ¶‰åŠå¤šçº¿ç¨‹åŒæ­¥ã€‚

## 4. åœ°ç‹±åˆ°å¤©å ‚ï¼šåç¨‹

ä»Šå¤©çš„ä¸»è§’æ˜¯åç¨‹ï¼Œä¸Šé¢çš„ä»£ç ç”¨åç¨‹åº”è¯¥å†™ï¼Ÿå¾ˆç®€å•ï¼Œæ ¸å¿ƒå°±æ˜¯ä¸‰è¡Œä»£ç ï¼š

```kotlin
val user = getUserInfo()
val friendList = getFriendList(user)
val feedList = getFeedList(friendList)
```

æ˜¯ä¸æ˜¯ç®€æ´åˆ°äº†æè‡´ï¼Ÿè¿™å°±æ˜¯ Kotlin åç¨‹çš„é­…åŠ›ï¼š`ä»¥åŒæ­¥çš„æ–¹å¼å®Œæˆå¼‚æ­¥ä»»åŠ¡`ã€‚

### 4-1 ä½¿ç”¨åç¨‹çš„è¦ç‚¹

ä»¥ä¸Šä»£ç çš„å…³é”®ï¼Œåœ¨äºé‚£ä¸‰ä¸ªè¯·æ±‚å‡½æ•°çš„å®šä¹‰ï¼Œå®ƒä»¬éƒ½è¢« `suspend` ä¿®é¥°ï¼Œè¿™ä»£è¡¨å®ƒä»¬éƒ½æ˜¯ï¼š`æŒ‚èµ·å‡½æ•°`ã€‚

```kotlin
// delay(1000L)ç”¨äºæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚

//æŒ‚èµ·å‡½æ•°
// â†“
suspend fun getUserInfo(): String {
    withContext(Dispatchers.IO) {
        delay(1000L)
    }
    return "BoyCoder"
}
//æŒ‚èµ·å‡½æ•°
// â†“
suspend fun getFriendList(user: String): String {
    withContext(Dispatchers.IO) {
        delay(1000L)
    }
    return "Tom, Jack"
}
//æŒ‚èµ·å‡½æ•°
// â†“
suspend fun getFeedList(list: String): String {
    withContext(Dispatchers.IO) {
        delay(1000L)
    }
    return "{FeedList..}"
}
```

é‚£ä¹ˆï¼ŒæŒ‚èµ·å‡½æ•°åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

### 4-2 æŒ‚èµ·å‡½æ•°

æŒ‚èµ·å‡½æ•°(Suspending Function)ï¼Œä»å­—é¢ä¸Šç†è§£ï¼Œå°±æ˜¯`å¯ä»¥è¢«æŒ‚èµ·çš„å‡½æ•°`ã€‚suspend æœ‰ï¼šæŒ‚èµ·ï¼Œ`æš‚åœ`çš„æ„æ€ã€‚åœ¨è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œä¹Ÿæœ‰ç‚¹æš‚åœçš„æ„æ€ã€‚æš‚åœæ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æŒ‚èµ·æ›´å‡†ç¡®ã€‚

æŒ‚èµ·å‡½æ•°ï¼Œèƒ½è¢«**ã€ŒæŒ‚èµ·ã€**ï¼Œå½“ç„¶ä¹Ÿèƒ½**ã€Œæ¢å¤ã€**ï¼Œä»–ä»¬ä¸€èˆ¬æ˜¯æˆå¯¹å‡ºç°çš„ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹æŒ‚èµ·å‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œæ³¨æ„åŠ¨ç”»å½“ä¸­å‡ºç°çš„`é—ªçƒ`ï¼Œè¿™ä»£è¡¨æ­£åœ¨è¯·æ±‚ç½‘ç»œã€‚

**ã€Œä¸€å®šè¦å¤šçœ‹å‡ éï¼Œç¡®ä¿æ²¡æœ‰é—æ¼å…¶ä¸­çš„ç»†èŠ‚ã€‚ã€**

[ğŸï¸](http://mpvideo.qpic.cn/0bf2wmgkuaamtuafsseh6bpvzm6dvkzqzkqa.f10003.mp4?dis_k=80d5d492997afbe46368e39859ae215a&dis_t=1635064076&vid=wxv_1567243755533959169&format_id=10003&support_redirect=0&mmversion=false)ï¼Œæ—¶é•¿00:30 Â· `è‹¥æ— æ³•æ’­æ”¾è¯·æ‰“å¼€åŸæ–‡è§‚çœ‹` [^5]

ä»ä¸Šé¢çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬èƒ½çŸ¥é“ï¼š

- è¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯åŒæ­¥çš„ä»£ç ï¼Œå®é™…ä¸Šä¹Ÿæ¶‰åŠåˆ°äº†çº¿ç¨‹åˆ‡æ¢ã€‚
- ä¸€è¡Œä»£ç ï¼Œåˆ‡æ¢äº†ä¸¤ä¸ªçº¿ç¨‹ã€‚
- `=`å·¦è¾¹ï¼šä¸»çº¿ç¨‹
- `=`å³è¾¹ï¼šIOçº¿ç¨‹
- æ¯ä¸€æ¬¡ä»`ä¸»çº¿ç¨‹`åˆ°`IOçº¿ç¨‹`ï¼Œéƒ½æ˜¯ä¸€æ¬¡åç¨‹`æŒ‚èµ·`(suspend)
- æ¯ä¸€æ¬¡ä»`IOçº¿ç¨‹`åˆ°`ä¸»çº¿ç¨‹`ï¼Œéƒ½æ˜¯ä¸€æ¬¡åç¨‹`æ¢å¤`(resume)ã€‚
- æŒ‚èµ·å’Œæ¢å¤ï¼Œè¿™æ˜¯æŒ‚èµ·å‡½æ•°ç‰¹æœ‰çš„èƒ½åŠ›ï¼Œæ™®é€šå‡½æ•°æ˜¯ä¸å…·å¤‡çš„ã€‚
- æŒ‚èµ·ï¼Œåªæ˜¯å°†ç¨‹åºæ‰§è¡Œæµç¨‹è½¬ç§»åˆ°äº†å…¶ä»–çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å¹¶æœªè¢«é˜»å¡ã€‚
- å¦‚æœä»¥ä¸Šä»£ç è¿è¡Œåœ¨ Android ç³»ç»Ÿï¼Œæˆ‘ä»¬çš„ App æ˜¯ä»ç„¶å¯ä»¥å“åº”ç”¨æˆ·çš„æ“ä½œçš„ï¼Œä¸»çº¿ç¨‹å¹¶ä¸ç¹å¿™ï¼Œè¿™ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ã€‚

æŒ‚èµ·å‡½æ•°çš„æ‰§è¡Œæµç¨‹æˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œé‚£ä¹ˆï¼ŒKotlin åç¨‹åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°`ä¸€è¡Œä»£ç åˆ‡æ¢ä¸¤ä¸ªçº¿ç¨‹`çš„ï¼Ÿ

è¿™ä¸€åˆ‡çš„`é­”æ³•`éƒ½è—åœ¨äº†æŒ‚èµ·å‡½æ•°çš„`suspend`å…³é”®å­—é‡Œã€‚

## 5. suspend çš„æœ¬è´¨

`suspend` çš„æœ¬è´¨ï¼Œå°±æ˜¯ `CallBack`ã€‚

```kotlin
suspend fun getUserInfo(): String {
    withContext(Dispatchers.IO) {
        delay(1000L)
    }
    return "BoyCoder"
}
```

æœ‰çš„å°ä¼™ä¼´è¦é—®äº†ï¼Œå“ªæ¥çš„ `CallBack`ï¼Ÿæ˜æ˜æ²¡æœ‰å•Šã€‚ç¡®å®ï¼Œæˆ‘ä»¬å†™å‡ºæ¥çš„ä»£ç æ²¡æœ‰ CallBackï¼Œä½† Kotlin çš„ç¼–è¯‘å™¨æ£€æµ‹åˆ° `suspend` å…³é”®å­—ä¿®é¥°çš„å‡½æ•°ä»¥åï¼Œä¼šè‡ªåŠ¨å°†æŒ‚èµ·å‡½æ•°è½¬æ¢æˆå¸¦æœ‰ CallBack çš„å‡½æ•°ã€‚

å¦‚æœæˆ‘ä»¬å°†ä¸Šé¢çš„æŒ‚èµ·å‡½æ•°åç¼–è¯‘æˆ Javaï¼Œç»“æœä¼šæ˜¯è¿™æ ·ï¼š

```kotlin
//                              Continuation ç­‰ä»·äº CallBack
//                                         â†“         
public static final Object getUserInfo(Continuation $completion) {
  ...
  return "BoyCoder";
}
```

ä»åç¼–è¯‘çš„ç»“æœæ¥çœ‹ï¼ŒæŒ‚èµ·å‡½æ•°ç¡®å®å˜æˆäº†ä¸€ä¸ªå¸¦æœ‰ `CallBack` çš„å‡½æ•°ï¼Œåªæ˜¯è¿™ä¸ª `CallBack` çš„çœŸå®åå­—å« `Continuation`ã€‚æ¯•ç«Ÿï¼Œå¦‚æœç›´æ¥å« `CallBack` é‚£å°±å¤ª `low`ï¼Œå¯¹å§ï¼Ÿ

æˆ‘ä»¬çœ‹çœ‹ Continuation åœ¨ Kotlin ä¸­çš„å®šä¹‰ï¼š

```kotlin
public interface Continuation<in T> {
    public val context: CoroutineContext
//      ç›¸å½“äº onSuccess     ç»“æœ   
//                 â†“         â†“
    public fun resumeWith(result: Result<T>)
}
```

å¯¹æ¯”ç€çœ‹çœ‹ CallBack çš„å®šä¹‰ï¼š

```kotlin
interface CallBack {
    void onSuccess(String response);
}
```

ä»ä¸Šé¢çš„å®šä¹‰æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼šContinuation å…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æ³›å‹å‚æ•°çš„  CallBackï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¤šäº†ä¸€ä¸ª `CoroutineContext`ï¼Œå®ƒå°±æ˜¯`åç¨‹çš„ä¸Šä¸‹æ–‡`ã€‚å¯¹äºç†Ÿæ‚‰ Android å¼€å‘çš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¸å°±æ˜¯ context å˜›ï¼ä¹Ÿæ²¡ä»€ä¹ˆéš¾ä»¥ç†è§£çš„ï¼Œå¯¹å§ï¼Ÿ

ä»¥ä¸Šè¿™ä¸ªä»`æŒ‚èµ·å‡½æ•°`è½¬æ¢æˆ`CallBack å‡½æ•°`çš„è¿‡ç¨‹ï¼Œè¢«ç§°ä¸ºï¼šCPS è½¬æ¢(Continuation-Passing-Style Transformation)ã€‚

çœ‹ï¼ŒKotlin å®˜æ–¹ç”¨ Continuation è€Œä¸ç”¨ CallBack çš„åŸå› å‡ºæ¥äº†ï¼šContinuation é“å‡ºäº†å®ƒçš„å®ç°åŸç†ã€‚å½“ç„¶ï¼Œä¸ºäº†ç†è§£`æŒ‚èµ·å‡½æ•°`ï¼Œæˆ‘ä»¬ç”¨ CallBack ä¼šæ›´åŠ çš„ç®€æ˜æ˜“æ‡‚ã€‚

ä¸‹é¢ç”¨åŠ¨ç”»æ¼”ç¤º`æŒ‚èµ·å‡½æ•°`åœ¨ CPS è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°ç­¾åçš„å˜åŒ–ï¼š

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241649325.gif)

è¿™ä¸ªè½¬æ¢çœ‹ç€ç®€å•ï¼Œå…¶ä¸­ä¹Ÿè—ç€ä¸€äº›ç»†èŠ‚ã€‚

### å‡½æ•°ç±»å‹çš„å˜åŒ–

ä¸Šé¢ CPS è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°çš„ç±»å‹å‘ç”Ÿäº†å˜åŒ–ï¼š`suspend ()->String` å˜æˆäº† `(Continuation)-> Any?`ã€‚

è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨ Java è®¿é—®ä¸€ä¸ª Kotlin æŒ‚èµ·å‡½æ•°`getUserInfo()`ï¼Œåœ¨ Java çœ‹åˆ° `getUserInfo()` çš„ç±»å‹ä¼šæ˜¯ï¼š`(Continuation)-> Object`ã€‚(æ¥æ”¶ Continuation ä¸ºå‚æ•°ï¼Œè¿”å›å€¼æ˜¯ Object)

åœ¨è¿™ä¸ª CPS è½¬æ¢ä¸­ï¼Œ`suspend ()` å˜æˆ `(Continuation)` æˆ‘ä»¬å‰é¢å·²ç»è§£é‡Šäº†ï¼Œä¸éš¾ã€‚é‚£ä¹ˆå‡½æ•°çš„è¿”å›å€¼ä¸ºä»€ä¹ˆä¼šä»ï¼š`String`å˜æˆ`Any?`

### æŒ‚èµ·å‡½æ•°çš„è¿”å›å€¼

æŒ‚èµ·å‡½æ•°ç»è¿‡ CPS è½¬æ¢åï¼Œå®ƒçš„è¿”å›å€¼æœ‰ä¸€ä¸ªé‡è¦ä½œç”¨ï¼š`æ ‡å¿—è¯¥æŒ‚èµ·å‡½æ•°æœ‰æ²¡æœ‰è¢«æŒ‚èµ·`ã€‚

è¿™å¬èµ·æ¥æœ‰ç‚¹ç»•ï¼šæŒ‚èµ·å‡½æ•°ï¼Œå°±æ˜¯å¯ä»¥è¢«æŒ‚èµ·çš„å‡½æ•°ï¼Œå®ƒè¿˜èƒ½ä¸è¢«æŒ‚èµ·å—ï¼Ÿæ˜¯çš„ï¼ŒæŒ‚èµ·å‡½æ•°ä¹Ÿèƒ½ä¸è¢«æŒ‚èµ·ã€‚

è®©æˆ‘ä»¬æ¥ç†æ¸…å‡ ä¸ªæ¦‚å¿µï¼š

åªè¦æœ‰ `suspend` ä¿®é¥°çš„å‡½æ•°ï¼Œå®ƒå°±æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢çš„ä¾‹å­ï¼š

```kotlin
suspend fun getUserInfo(): String {
    withContext(Dispatchers.IO) {
        delay(1000L)
    }
    return "BoyCoder"
}
```

å½“ getUserInfo() æ‰§è¡Œåˆ° `withContext`çš„æ—¶å€™ï¼Œå°±ä¼šè¿”å› `CoroutineSingletons.COROUTINE_SUSPENDED` è¡¨ç¤ºå‡½æ•°è¢«æŒ‚èµ·äº†ã€‚

ç°åœ¨é—®é¢˜æ¥äº†ï¼Œè¯·é—®ä¸‹é¢è¿™ä¸ªå‡½æ•°æ˜¯æŒ‚èµ·å‡½æ•°å—ï¼š

```kotlin
// suspend ä¿®é¥°
// â†“
suspend fun noSuspendFriendList(user: String): String{
    // å‡½æ•°ä½“è·Ÿæ™®é€šå‡½æ•°ä¸€æ ·
    return "Tom, Jack"
}
```

ç­”æ¡ˆï¼šå®ƒæ˜¯æŒ‚èµ·å‡½æ•°ã€‚ä½†å®ƒè·Ÿä¸€èˆ¬çš„æŒ‚èµ·å‡½æ•°æœ‰ä¸ªåŒºåˆ«ï¼šå®ƒåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œå› ä¸ºå®ƒå°±æ˜¯æ™®é€šå‡½æ•°ã€‚å½“ä½ å†™å‡ºè¿™æ ·çš„ä»£ç åï¼ŒIDE ä¹Ÿä¼šæç¤ºä½ ï¼Œsuspend æ˜¯å¤šä½™çš„ï¼š

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630868.webp)

å½“ `noSuspendFriendList()` è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä¼šæŒ‚èµ·ï¼Œå®ƒä¼šç›´æ¥è¿”å› String ç±»å‹ï¼š`"no suspend"`ã€‚è¿™æ ·çš„æŒ‚èµ·å‡½æ•°ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œ**ã€Œä¼ªæŒ‚èµ·å‡½æ•°ã€**

### è¿”å›ç±»å‹æ˜¯ Anyï¼Ÿçš„åŸå› 

ç”±äº suspend ä¿®é¥°çš„å‡½æ•°ï¼Œæ—¢å¯èƒ½è¿”å› `CoroutineSingletons.COROUTINE_SUSPENDED`ï¼Œä¹Ÿå¯èƒ½è¿”å›å®é™…ç»“æœ`"no suspend"`ï¼Œç”šè‡³å¯èƒ½è¿”å› `null`ï¼Œä¸ºäº†é€‚é…æ‰€æœ‰çš„å¯èƒ½æ€§ï¼ŒCPS è½¬æ¢åçš„å‡½æ•°è¿”å›å€¼ç±»å‹å°±åªèƒ½æ˜¯ `Any?`äº†ã€‚

### å°ç»“

- suspend ä¿®é¥°çš„å‡½æ•°å°±æ˜¯`æŒ‚èµ·å‡½æ•°`
- æŒ‚èµ·å‡½æ•°ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™å¹¶ä¸ä¸€å®šéƒ½ä¼šæŒ‚èµ·
- æŒ‚èµ·å‡½æ•°åªèƒ½åœ¨å…¶ä»–æŒ‚èµ·å‡½æ•°ä¸­è¢«è°ƒç”¨(or åç¨‹ä½œç”¨åŸŸ)
- æŒ‚èµ·å‡½æ•°é‡ŒåŒ…å«å…¶ä»–æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šçœŸæ­£è¢«æŒ‚èµ·

ä»¥ä¸Šå°±æ˜¯ CPS è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°ç­¾åçš„ç»†èŠ‚ã€‚

ç„¶è€Œï¼Œè¿™å¹¶ä¸æ˜¯ CPS è½¬æ¢çš„å…¨éƒ¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜ä¸çŸ¥é“ Continuation åˆ°åº•æ˜¯ä»€ä¹ˆã€‚

## 6. CPS è½¬æ¢

Continuation è¿™ä¸ªå•è¯ï¼Œå¦‚æœä½ æŸ¥è¯å…¸[^2]å’Œç»´åŸºç™¾ç§‘[^3]ï¼Œå¯èƒ½ä¼šä¸€å¤´é›¾æ°´ï¼Œå¤ªæŠ½è±¡äº†ã€‚

é€šè¿‡æˆ‘ä»¬æ–‡ç« çš„ä¾‹å­æ¥ç†è§£ Continuationï¼Œä¼šæ›´å®¹æ˜“ä¸€äº›ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ¡ä½ Continuation çš„è¯æº `Continue` å³å¯ã€‚Continue æ˜¯`ç»§ç»­`çš„æ„æ€ï¼ŒContinuation åˆ™æ˜¯ç»§ç»­ä¸‹å»è¦åšçš„äº‹æƒ…ï¼Œ`æ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…`ã€‚

æ”¾åˆ°ç¨‹åºä¸­ï¼ŒContinuation åˆ™ä»£è¡¨äº†ï¼Œç¨‹åºç»§ç»­è¿è¡Œä¸‹å»éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼Œ`æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ä»£ç ` æˆ–è€… `å‰©ä¸‹çš„ä»£ç `ã€‚

ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼Œå½“ç¨‹åºè¿è¡Œ `getUserInfo()` çš„æ—¶å€™ï¼Œå®ƒçš„ `Continuation`åˆ™æ˜¯ä¸‹å›¾çº¢æ¡†çš„ä»£ç ï¼š

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Continuation å°±æ˜¯`æ¥ä¸‹æ¥è¦è¿è¡Œçš„ä»£ç `ï¼Œ`å‰©ä½™æœªæ‰§è¡Œçš„ä»£ç `ã€‚

ç†è§£äº† Continuationï¼Œä»¥åï¼Œ`CPS`å°±å®¹æ˜“ç†è§£äº†ï¼Œå®ƒå…¶å®å°±æ˜¯ï¼š`å°†ç¨‹åºæ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ä»£ç è¿›è¡Œä¼ é€’çš„ä¸€ç§æ¨¡å¼ã€‚`

è€Œ`CPS è½¬æ¢`ï¼Œå°±æ˜¯å°†åŸæœ¬çš„`åŒæ­¥æŒ‚èµ·å‡½æ•°`è½¬æ¢æˆ`CallBack å¼‚æ­¥ä»£ç `çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè½¬æ¢æ˜¯ç¼–è¯‘å™¨åœ¨èƒŒååšçš„ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜å¯¹æ­¤æ— æ„ŸçŸ¥ã€‚

![å›¾ç‰‡](https://gitee.com/yzketx/image-markdown/raw/master/img/202110241630100.gif)

ä¹Ÿè®¸ä¼šæœ‰å°ä¼™ä¼´å—¤ä¹‹ä»¥é¼»ï¼š`è¿™ä¹ˆç®€å•ç²—æš´ï¼Ÿä¸‰ä¸ªæŒ‚èµ·å‡½æ•°æœ€ç»ˆå˜æˆä¸‰ä¸ª Callback å—ï¼Ÿ`

å½“ç„¶ä¸æ˜¯ã€‚æ€æƒ³ä»ç„¶æ˜¯ CPS çš„æ€æƒ³ï¼Œä½†è¦æ¯” Callback é«˜æ˜å¾ˆå¤šã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹æŒ‚èµ·å‡½æ•°åç¼–è¯‘åçš„ä»£ç æ˜¯ä»€ä¹ˆæ ·å§ã€‚å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šï¼Œå…¨éƒ½æ˜¯ä¸ºäº†ä¸‹ä¸€ä¸ªéƒ¨åˆ†å‡†å¤‡çš„ã€‚

## 7. å­—èŠ‚ç åç¼–è¯‘

å­—èŠ‚ç åç¼–è¯‘æˆ Java è¿™ç§äº‹ï¼Œæˆ‘ä»¬å¹²è¿‡å¾ˆå¤šæ¬¡äº†ã€‚è·Ÿå¾€å¸¸ä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä¸ä¼šç›´æ¥è´´åç¼–è¯‘åçš„ä»£ç ï¼Œå› ä¸ºå¦‚æœæˆ‘ç›´æ¥è´´å‡ºåç¼–è¯‘åçš„ Java ä»£ç ï¼Œä¼°è®¡ä¼šå“é€€ä¸€å¤§æ³¢äººã€‚åç¨‹åç¼–è¯‘åçš„ä»£ç ï¼Œé€»è¾‘å®åœ¨æ˜¯å¤ªç»•äº†ï¼Œå¯è¯»æ€§å®åœ¨å¤ªå·®äº†ã€‚è¿™æ ·çš„ä»£ç ï¼ŒCPU å¯èƒ½å–œæ¬¢ï¼Œä½†çœŸä¸æ˜¯äººçœ‹çš„ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘è´´å‡ºçš„ä»£ç æ˜¯æˆ‘ç”¨ Kotlin ç¿»è¯‘å`å¤§è‡´ç­‰ä»·`çš„ä»£ç ï¼Œæ”¹å–„äº†å¯è¯»æ€§ï¼ŒæŠ¹æ‰äº†ä¸å¿…è¦çš„ç»†èŠ‚ã€‚**ã€Œå¦‚æœä½ èƒ½æŠŠè¿™ç¯‡æ–‡ç« é‡Œæ‰€æœ‰å†…å®¹éƒ½å¼„æ‡‚ï¼Œä½ å¯¹åç¨‹çš„ç†è§£ä¹Ÿå·²ç»è¶…è¿‡å¤§éƒ¨åˆ†äººäº†ã€‚ã€**

è¿›å…¥æ­£é¢˜ï¼Œè¿™æ˜¯æˆ‘ä»¬å³å°†ç ”ç©¶çš„å¯¹è±¡ï¼Œ`testCoroutine` åç¼–è¯‘å‰çš„ä»£ç ï¼š

```kotlin
suspend fun testCoroutine() {
    log("start")
    val user = getUserInfo()
    log(user)
    val friendList = getFriendList(user)
    log(friendList)
    val feedList = getFeedList(friendList)
    log(feedList)
}
```

åç¼–è¯‘åï¼Œ`testCoroutine`å‡½æ•°çš„ç­¾åå˜æˆäº†è¿™æ ·ï¼š

```kotlin
// æ²¡äº† suspendï¼Œå¤šäº† completion
fun testCoroutine(completion: Continuation<Any?>): Any? {}
```

ç”±äºå…¶ä»–å‡ ä¸ªå‡½æ•°ä¹Ÿæ˜¯æŒ‚èµ·å‡½æ•°ï¼Œæ‰€ä»¥å®ƒä»¬çš„å‡½æ•°ç­¾åä¹Ÿä¼šæ”¹å˜ï¼š

```kotlin
fun getUserInfo(completion: Continuation<Any?>): Any?{}
fun getFriendList(user: String, completion: Continuation<Any?>): Any?{}
fun getFeedList(friendList: String, completion: Continuation<Any?>): Any?{}
```

æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æ `testCoroutine()` çš„å‡½æ•°ä½“ï¼Œå› ä¸ºå®ƒç›¸å½“å¤æ‚ï¼Œæ¶‰åŠåˆ°ä¸‰ä¸ªæŒ‚èµ·å‡½æ•°çš„è°ƒç”¨ã€‚

é¦–å…ˆï¼Œåœ¨ testCoroutine å‡½æ•°é‡Œï¼Œä¼šå¤šå‡ºä¸€ä¸ª ContinuationImpl çš„å­ç±»ï¼Œå®ƒçš„æ˜¯æ•´ä¸ªåç¨‹æŒ‚èµ·å‡½æ•°çš„æ ¸å¿ƒã€‚ä»£ç é‡Œçš„æ³¨é‡Šéå¸¸è¯¦ç»†ï¼Œè¯·ä»”ç»†çœ‹ã€‚

```kotlin
fun testCoroutine(completion: Continuation<Any?>): Any? {

    class TestContinuation(completion: Continuation<Any?>?) : ContinuationImpl(completion) {
        // è¡¨ç¤ºåç¨‹çŠ¶æ€æœºå½“å‰çš„çŠ¶æ€
        var label: Int = 0
        // åç¨‹è¿”å›ç»“æœ
        var result: Any? = null

        // ç”¨äºä¿å­˜ä¹‹å‰åç¨‹çš„è®¡ç®—ç»“æœ
        var mUser: Any? = null
        var mFriendList: Any? = null

        // invokeSuspend æ˜¯åç¨‹çš„å…³é”®
        // å®ƒæœ€ç»ˆä¼šè°ƒç”¨ testCoroutine(this) å¼€å¯åç¨‹çŠ¶æ€æœº
        // çŠ¶æ€æœºç›¸å…³ä»£ç å°±æ˜¯åé¢çš„ when è¯­å¥
        // åç¨‹çš„æœ¬è´¨ï¼Œå¯ä»¥è¯´å°±æ˜¯ CPS + çŠ¶æ€æœº
        override fun invokeSuspend(_result: Result<Any?>): Any? {
            result = _result
            label = label or Int.Companion.MIN_VALUE
            return testCoroutine(this)
        }
    }
}
```

æ¥ä¸‹æ¥åˆ™æ˜¯è¦åˆ¤æ–­ testCoroutine æ˜¯ä¸æ˜¯åˆæ¬¡è¿è¡Œï¼Œå¦‚æœæ˜¯åˆæ¬¡è¿è¡Œï¼Œå°±è¦åˆ›å»ºä¸€ä¸ª TestContinuation çš„å®ä¾‹å¯¹è±¡ã€‚

```kotlin
//                    â†“
fun testCoroutine(completion: Continuation<Any?>): Any? {
    ...
    val continuation = if (completion is TestContinuation) {
        completion
    } else {
        //                ä½œä¸ºå‚æ•°
        //                   â†“
        TestContinuation(completion)
    }
}
```

- invokeSuspend æœ€ç»ˆä¼šè°ƒç”¨ testCoroutineï¼Œç„¶åèµ°åˆ°è¿™ä¸ªåˆ¤æ–­è¯­å¥
- å¦‚æœæ˜¯åˆæ¬¡è¿è¡Œï¼Œä¼šåˆ›å»ºä¸€ä¸ª TestContinuation å¯¹è±¡ï¼Œcompletion ä½œä¸ºäº†å‚æ•°
- è¿™ç›¸å½“äºç”¨ä¸€ä¸ª**ã€Œæ–°çš„ã€** Continuation åŒ…è£…äº†**ã€Œæ—§çš„ã€** Continuation
- å¦‚æœä¸æ˜¯åˆæ¬¡è¿è¡Œï¼Œç›´æ¥å°† completion èµ‹å€¼ç»™ continuation
- è¿™è¯´æ˜ continuation åœ¨æ•´ä¸ªè¿è¡ŒæœŸé—´ï¼Œåªä¼šäº§ç”Ÿä¸€ä¸ªå®ä¾‹ï¼Œè¿™èƒ½æå¤§çš„èŠ‚çœå†…å­˜å¼€é”€(å¯¹æ¯” CallBack)

æ¥ä¸‹æ¥æ˜¯å‡ ä¸ªå˜é‡çš„å®šä¹‰ï¼Œä»£ç é‡Œä¼šæœ‰è¯¦ç»†çš„æ³¨é‡Šï¼š

```kotlin
// ä¸‰ä¸ªå˜é‡ï¼Œå¯¹åº”åŸå‡½æ•°çš„ä¸‰ä¸ªå˜é‡
lateinit var user: String
lateinit var friendList: String
lateinit var feedList: String

// result æ¥æ”¶åç¨‹çš„è¿è¡Œç»“æœ
var result = continuation.result

// suspendReturn æ¥æ”¶æŒ‚èµ·å‡½æ•°çš„è¿”å›å€¼
var suspendReturn: Any? = null

// CoroutineSingletons æ˜¯ä¸ªæšä¸¾ç±»
// COROUTINE_SUSPENDED ä»£è¡¨å½“å‰å‡½æ•°è¢«æŒ‚èµ·äº†
val sFlag = CoroutineSingletons.COROUTINE_SUSPENDED
```

ç„¶åå°±åˆ°äº†æˆ‘ä»¬çš„çŠ¶æ€æœºçš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œå…·ä½“çœ‹æ³¨é‡Šå§ï¼š

```kotlin
when (continuation.label) {
    0 -> {
        // æ£€æµ‹å¼‚å¸¸
        throwOnFailure(result)

        log("start")
        // å°† label ç½®ä¸º 1ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€æ¬¡çŠ¶æ€
        continuation.label = 1

        // æ‰§è¡Œ getUserInfo
        suspendReturn = getUserInfo(continuation)

        // åˆ¤æ–­æ˜¯å¦æŒ‚èµ·
        if (suspendReturn == sFlag) {
            return suspendReturn
        } else {
            result = suspendReturn
            //go to next state
        }
    }

    1 -> {
        throwOnFailure(result)

        // è·å– user å€¼
        user = result as String
        log(user)
        // å°†åç¨‹ç»“æœå­˜åˆ° continuation é‡Œ
        continuation.mUser = user
        // å‡†å¤‡è¿›å…¥ä¸‹ä¸€ä¸ªçŠ¶æ€
        continuation.label = 2

        // æ‰§è¡Œ getFriendList
        suspendReturn = getFriendList(user, continuation)

        // åˆ¤æ–­æ˜¯å¦æŒ‚èµ·
        if (suspendReturn == sFlag) {
            return suspendReturn
        } else {
            result = suspendReturn
            //go to next state
        }
    }

    2 -> {
        throwOnFailure(result)

        user = continuation.mUser as String

        // è·å– friendList çš„å€¼
        friendList = result as String
        log(friendList)

        // å°†åç¨‹ç»“æœå­˜åˆ° continuation é‡Œ
        continuation.mUser = user
        continuation.mFriendList = friendList

        // å‡†å¤‡è¿›å…¥ä¸‹ä¸€ä¸ªçŠ¶æ€
        continuation.label = 3

        // æ‰§è¡Œ getFeedList
        suspendReturn = getFeedList(friendList, continuation)

        // åˆ¤æ–­æ˜¯å¦æŒ‚èµ·
        if (suspendReturn == sFlag) {
            return suspendReturn
        } else {
            result = suspendReturn
            //go to next state
        }
    }

    3 -> {
        throwOnFailure(result)

        user = continuation.mUser as String
        friendList = continuation.mFriendList as String
        feedList = continuation.result as String
        log(feedList)
        loop = false
    }
}
```

- when è¡¨è¾¾å¼å®ç°äº†åç¨‹çŠ¶æ€æœº
- `continuation.label` æ˜¯çŠ¶æ€æµè½¬çš„å…³é”®
- `continuation.label` æ”¹å˜ä¸€æ¬¡ï¼Œå°±ä»£è¡¨åç¨‹åˆ‡æ¢äº†ä¸€æ¬¡
- æ¯æ¬¡åç¨‹åˆ‡æ¢åï¼Œéƒ½ä¼šæ£€æŸ¥æ˜¯å¦å‘ç”Ÿå¼‚å¸¸
- testCoroutine é‡Œçš„åŸæœ¬çš„ä»£ç ï¼Œè¢«`æ‹†åˆ†`åˆ°çŠ¶æ€æœºé‡Œå„ä¸ªçŠ¶æ€ä¸­ï¼Œ`åˆ†å¼€æ‰§è¡Œ`
- getUserInfo(continuation)ï¼ŒgetFriendList(user, continuation)ï¼ŒgetFeedList(friendList, continuation) ä¸‰ä¸ªå‡½æ•°è°ƒç”¨ä¼ çš„åŒä¸€ä¸ª `continuation` å®ä¾‹ã€‚
- ä¸€ä¸ªå‡½æ•°å¦‚æœè¢«æŒ‚èµ·äº†ï¼Œå®ƒçš„è¿”å›å€¼ä¼šæ˜¯ï¼š`CoroutineSingletons.COROUTINE_SUSPENDED`
- åˆ‡æ¢åç¨‹ä¹‹å‰ï¼ŒçŠ¶æ€æœºä¼šæŠŠä¹‹å‰çš„ç»“æœä»¥æˆå‘˜å˜é‡çš„æ–¹å¼ä¿å­˜åœ¨ `continuation` ä¸­ã€‚

**ã€Œè­¦å‘Šï¼šä»¥ä¸Šçš„ä»£ç æ˜¯æˆ‘ç”¨ Kotlin å†™å‡ºçš„æ”¹è‰¯ç‰ˆåç¼–è¯‘ä»£ç ï¼Œåç¨‹åç¼–è¯‘åçœŸå®çš„ä»£ç åé¢æˆ‘ä¹Ÿä¼šæ”¾å‡ºæ¥ï¼Œè¯·ç»§ç»­çœ‹ã€‚ã€**

## 8. åç¨‹çŠ¶æ€æœºåŠ¨ç”»æ¼”ç¤º

ä¸Šé¢ä¸€å¤§ä¸²æ–‡å­—å’Œä»£ç çœ‹ç€æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•ï¼Ÿè¯·çœ‹çœ‹è¿™ä¸ªåŠ¨ç”»æ¼”ç¤ºï¼Œçœ‹å®ŒåŠ¨ç”»æ¼”ç¤ºäº†ï¼Œå›è¿‡å¤´å†çœ‹ä¸Šé¢çš„æ–‡å­—ï¼Œä½ ä¼šæœ‰æ›´å¤šæ”¶è·ã€‚

[ğŸï¸](http://mpvideo.qpic.cn/0bf2mygksaam74afqw4h45pvyzwdvftazkia.f10003.mp4?dis_k=f3658b30db6333f12c52b14fecc300e6&dis_t=1635064076&vid=wxv_1567236957322149890&format_id=10003&support_redirect=0&mmversion=false)ï¼Œæ—¶é•¿01:32 Â· `è‹¥æ— æ³•æ’­æ”¾è¯·æ‰“å¼€åŸæ–‡è§‚çœ‹` [^5]

æ˜¯ä¸æ˜¯å®Œäº†å‘¢ï¼Ÿå¹¶ä¸ï¼Œå› ä¸ºä¸Šé¢çš„åŠ¨ç”»ä»…æ¼”ç¤ºäº†æ¯ä¸ªåç¨‹æ­£å¸¸æŒ‚èµ·çš„æƒ…å†µã€‚å¦‚æœåç¨‹å¹¶æ²¡æœ‰çœŸæ­£æŒ‚èµ·å‘¢ï¼Ÿåç¨‹çŠ¶æ€æœºä¼šæ€ä¹ˆè¿è¡Œï¼Ÿ

### åç¨‹æœªæŒ‚èµ·çš„æƒ…å†µ

è¦éªŒè¯ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªæŒ‚èµ·å‡½æ•°æ”¹æˆ`ä¼ªæŒ‚èµ·å‡½æ•°`å³å¯ã€‚

```kotlin
// â€œä¼ªâ€æŒ‚èµ·å‡½æ•°
// è™½ç„¶å®ƒæœ‰ suspend ä¿®é¥°ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™å¹¶ä¸ä¼šçœŸæ­£æŒ‚èµ·ï¼Œå› ä¸ºå®ƒå‡½æ•°ä½“é‡Œæ²¡æœ‰å…¶ä»–æŒ‚èµ·å‡½æ•°
//  â†“
suspend fun noSuspendFriendList(user: String): String{
    return "Tom, Jack"
}

suspend fun testNoSuspend() {
    log("start")
    val user = getUserInfo()
    log(user)                  
    //                  å˜åŒ–åœ¨è¿™é‡Œ
    //                      â†“
    val friendList = noSuspendFriendList(user)
    log(friendList)
    val feedList = getFeedList(friendList)
    log(feedList)
}
```

`testNoSuspend()`è¿™æ ·çš„ä¸€ä¸ªå‡½æ•°ä½“ï¼Œå®ƒçš„åç¼–è¯‘åçš„ä»£ç é€»è¾‘æ€ä¹ˆæ ·çš„ï¼Ÿ

ç­”æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œ**ã€Œå®ƒçš„ç»“æ„è·Ÿå‰é¢çš„`testCoroutine()`æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯å‡½æ•°åå­—å˜äº†è€Œå·²ï¼ŒKotlin ç¼–è¯‘å™¨ CPS è½¬æ¢çš„é€»è¾‘åªè®¤ suspend å…³é”®å­—ã€**ã€‚å°±ç®—æ˜¯`â€œä¼ªâ€æŒ‚èµ·å‡½æ•°`ï¼ŒKotlin ç¼–è¯‘å™¨ä¹Ÿç…§æ ·ä¼šè¿›è¡Œ CPS è½¬æ¢ã€‚

```kotlin
when (continuation.label) {
    0 -> {
        ...
    }

    1 -> {
        ...
        //               å˜åŒ–åœ¨è¿™é‡Œ
        //                   â†“
        suspendReturn = noSuspendFriendList(user, continuation)

        // åˆ¤æ–­æ˜¯å¦æŒ‚èµ·
        if (suspendReturn == sFlag) {
            return suspendReturn
        } else {
            result = suspendReturn
            //go to next state
        }
    }

    2 -> {
        ...
    }

    3 -> {
        ...
    }
}
```

`testNoSuspend()`çš„åç¨‹çŠ¶æ€æœºæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿ

å…¶å®å¾ˆå®¹æ˜“èƒ½æƒ³åˆ°ï¼Œcontinuation.label = 0ï¼Œ2ï¼Œ3 çš„æƒ…å†µéƒ½æ˜¯ä¸å˜çš„ï¼Œå”¯ç‹¬åœ¨ label = 1 çš„æ—¶å€™ï¼Œ`suspendReturn == sFlag`è¿™é‡Œä¼šæœ‰åŒºåˆ«ã€‚

å…·ä½“åŒºåˆ«æˆ‘ä»¬é€šè¿‡åŠ¨ç”»æ¥çœ‹å§ï¼š

[ğŸï¸](http://mpvideo.qpic.cn/0b78eeaawaaalyapqo4lizpvaiodbmqqacya.f10003.mp4?dis_k=ad13d0d5562b482865441adb9a965d8b&dis_t=1635064076&vid=wxv_1567245114555564037&format_id=10003&support_redirect=0&mmversion=false)ï¼Œæ—¶é•¿00:26 Â· `è‹¥æ— æ³•æ’­æ”¾è¯·æ‰“å¼€åŸæ–‡è§‚çœ‹` [^5]

é€šè¿‡åŠ¨ç”»æˆ‘ä»¬å¾ˆæ¸…æ¥šçš„çœ‹åˆ°äº†ï¼Œå¯¹äº`â€œä¼ªâ€æŒ‚èµ·å‡½æ•°`ï¼Œ`suspendReturn == sFlag`æ˜¯ä¼šèµ° else åˆ†æ”¯çš„ï¼Œåœ¨ else åˆ†æ”¯é‡Œï¼Œåç¨‹çŠ¶æ€æœºä¼šç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚

ç°åœ¨åªå‰©æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼š

```kotlin
if (suspendReturn == sFlag) {
} else {
    // å…·ä½“ä»£ç æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
    //       â†“
    //go to next state
}
```

ç­”æ¡ˆå…¶å®ä¹Ÿå¾ˆç®€å•ï¼šå¦‚æœä½ å»çœ‹åç¨‹çŠ¶æ€æœºçš„å­—èŠ‚ç åç¼–è¯‘åçš„ Javaï¼Œä¼šçœ‹åˆ°å¾ˆå¤š labelã€‚åç¨‹çŠ¶æ€æœºåº•å±‚å­—èŠ‚ç æ˜¯é€šè¿‡ `label` æ¥å®ç°è¿™ä¸ª`go to next state`çš„ã€‚ç”±äº Kotlin æ²¡æœ‰ç±»ä¼¼ goto çš„è¯­æ³•ï¼Œä¸‹é¢æˆ‘ç”¨ä¼ªä»£ç æ¥è¡¨ç¤º`go to next state`çš„é€»è¾‘ã€‚

```kotlin
// ä¼ªä»£ç 
// Kotlin æ²¡æœ‰è¿™æ ·çš„è¯­æ³•
// â†“      â†“
label: whenStart
when (continuation.label) {
    0 -> {
        ...
    }

    1 -> {
        ...
        suspendReturn = noSuspendFriendList(user, continuation)
        if (suspendReturn == sFlag) {
            return suspendReturn
        } else {
            result = suspendReturn
            // è®©ç¨‹åºè·³è½¬åˆ° label æ ‡è®°çš„åœ°æ–¹
            // ä»è€Œå†æ‰§è¡Œä¸€æ¬¡ when è¡¨è¾¾å¼
            goto: whenStart
        }
    }

    2 -> {
        ...
    }

    3 -> {
        ...
    }
}
```

`æ³¨æ„ï¼š`ä»¥ä¸Šæ˜¯ä¼ªä»£ç ï¼Œå®ƒåªæ˜¯è·Ÿåç¨‹çŠ¶æ€æœºå­—èŠ‚ç `é€»è¾‘ä¸Šç­‰ä»·`ï¼Œä¸ºäº†ä¸æ¯æ‰ä½ é’»ç ”åç¨‹çš„ä¹è¶£ï¼Œæˆ‘ä¸æ‰“ç®—åœ¨è¿™é‡Œè§£é‡Šåç¨‹åŸå§‹çš„å­—èŠ‚ç ã€‚æˆ‘ç›¸ä¿¡å¦‚æœä½ ç†è§£äº†æˆ‘çš„æ–‡ç« ä»¥åï¼Œå†å»çœ‹åç¨‹åç¼–è¯‘çš„çœŸå®ä»£ç ï¼Œä¸€å®šä¼šæ¸¸åˆƒæœ‰ä½™ã€‚

ä¸‹é¢çš„å»ºè®®ä¼šæœ‰åŠ©äºä½ çœ‹åç¨‹çœŸå®çš„å­—èŠ‚ç ï¼šåç¨‹çŠ¶æ€æœºçœŸå®çš„åŸç†æ˜¯ï¼šé€šè¿‡ label ä»£ç æ®µåµŒå¥—ï¼Œé…åˆ switch å·§å¦™æ„é€ å‡ºä¸€ä¸ªçŠ¶æ€æœºç»“æ„ï¼Œè¿™ç§é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç›¸å¯¹éš¾æ‡‚ä¸€äº›ã€‚(æ¯•ç«Ÿ Java çš„ label åœ¨å®é™…å¼€å‘ä¸­ç”¨çš„å¾ˆå°‘ã€‚)

çœŸå®çš„åç¨‹åç¼–è¯‘ä»£ç å¤§æ¦‚é•¿è¿™æ ·ï¼š

```java
@Nullable
public static final Object testCoroutine(@NotNull Continuation $completion) {
    Object $continuation;
    label37: {
        if ($completion instanceof <TestSuspendKt$testCoroutine$1>) {
            $continuation = (<TestSuspendKt$testCoroutine$1>)$completion;
            if ((((<TestSuspendKt$testCoroutine$1>)$continuation).label & Integer.MIN_VALUE) != 0) {
                ((<TestSuspendKt$testCoroutine$1>)$continuation).label -= Integer.MIN_VALUE;
                break label37;
            }
        }

        $continuation = new ContinuationImpl($completion) {
            // $FF: synthetic field
            Object result;
            int label;
            Object L$0;
            Object L$1;

            @Nullable
            public final Object invokeSuspend(@NotNull Object $result) {
                this.result = $result;
                this.label |= Integer.MIN_VALUE;
                return TestSuspendKt.testCoroutine(this);
            }
        };
    }

    Object var10000;
    label31: {
        String user;
        String friendList;
        Object var6;
        label30: {
            Object $result = ((<TestSuspendKt$testCoroutine$1>)$continuation).result;
            var6 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
            switch(((<TestSuspendKt$testCoroutine$1>)$continuation).label) {
                case 0:
                    ResultKt.throwOnFailure($result);
                    log("start");
                    ((<TestSuspendKt$testCoroutine$1>)$continuation).label = 1;
                    var10000 = getUserInfo((Continuation)$continuation);
                    if (var10000 == var6) {
                        return var6;
                    }
                    break;
                case 1:
                    ResultKt.throwOnFailure($result);
                    var10000 = $result;
                    break;
                case 2:
                    user = (String)((<TestSuspendKt$testCoroutine$1>)$continuation).L$0;
                    ResultKt.throwOnFailure($result);
                    var10000 = $result;
                    break label30;
                case 3:
                    friendList = (String)((<TestSuspendKt$testCoroutine$1>)$continuation).L$1;
                    user = (String)((<TestSuspendKt$testCoroutine$1>)$continuation).L$0;
                    ResultKt.throwOnFailure($result);
                    var10000 = $result;
                    break label31;
                default:
                    throw new IllegalStateException("call to 'resume' before 'invoke' with coroutine");
            }

            user = (String)var10000;
            log(user);
            ((<TestSuspendKt$testCoroutine$1>)$continuation).L$0 = user;
            ((<TestSuspendKt$testCoroutine$1>)$continuation).label = 2;
            var10000 = getFriendList(user, (Continuation)$continuation);
            if (var10000 == var6) {
                return var6;
            }
        }

        friendList = (String)var10000;
        log(friendList);
        ((<TestSuspendKt$testCoroutine$1>)$continuation).L$0 = user;
        ((<TestSuspendKt$testCoroutine$1>)$continuation).L$1 = friendList;
        ((<TestSuspendKt$testCoroutine$1>)$continuation).label = 3;
        var10000 = getFeedList(friendList, (Continuation)$continuation);
        if (var10000 == var6) {
            return var6;
        }
    }

    String feedList = (String)var10000;
    log(feedList);
    return Unit.INSTANCE;
}
```

## 9. ç»“å°¾

å›è¿‡å¤´å†çœ‹åç¨‹å’Œçº¿ç¨‹çš„å…³ç³»ï¼š

### çº¿ç¨‹

- çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„æ¦‚å¿µ
- æˆ‘ä»¬å¼€å‘è€…é€šè¿‡ç¼–ç¨‹è¯­è¨€(Thread.java)åˆ›å»ºçš„çº¿ç¨‹ï¼Œæœ¬è´¨è¿˜æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸çº¿ç¨‹çš„æ˜ å°„
- JVM ä¸­çš„çº¿ç¨‹ä¸å†…æ ¸çº¿ç¨‹çš„å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œæœ‰â€œä¸€å¯¹ä¸€â€ï¼Œâ€œä¸€å¯¹å¤šâ€ï¼Œâ€œMå¯¹Nâ€ã€‚JVM åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸­çš„å…·ä½“å®ç°ä¼šæœ‰å·®åˆ«ï¼Œâ€œä¸€å¯¹ä¸€â€æ˜¯ä¸»æµ
- ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¯´çš„çº¿ç¨‹ï¼Œéƒ½æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œè°ƒåº¦ï¼Œéƒ½ç”±æ“ä½œç³»ç»Ÿè´Ÿè´£
- çº¿ç¨‹ä¹Ÿä¼šæ¶ˆè€—æ“ä½œç³»ç»Ÿèµ„æºï¼Œä½†æ¯”è¿›ç¨‹è½»é‡å¾—å¤š
- çº¿ç¨‹ï¼Œæ˜¯æŠ¢å å¼çš„ï¼Œå®ƒä»¬ä¹‹é—´èƒ½å…±äº«å†…å­˜èµ„æºï¼Œè¿›ç¨‹ä¸è¡Œ
- çº¿ç¨‹å…±äº«èµ„æºå¯¼è‡´äº†`å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜`
- æœ‰çš„ç¼–ç¨‹è¯­è¨€ä¼šè‡ªå·±å®ç°ä¸€å¥—çº¿ç¨‹åº“ï¼Œä»è€Œèƒ½åœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸­å®ç°å¤šçº¿ç¨‹æ•ˆæœï¼Œæ—©æœŸ JVM çš„â€œç»¿è‰²çº¿ç¨‹â€ å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œè¿™ç§çº¿ç¨‹è¢«ç§°ä¸ºâ€œç”¨æˆ·çº¿ç¨‹â€

æœ‰çš„äººä¼šå°†çº¿ç¨‹æ¯”å–»æˆï¼šè½»é‡çº§çš„è¿›ç¨‹ã€‚

### åç¨‹

- Kotlin åç¨‹ï¼Œä¸æ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„æ¦‚å¿µï¼Œæ— éœ€æ“ä½œç³»ç»Ÿæ”¯æŒ
- Kotlin åç¨‹ï¼Œæœ‰ç‚¹åƒä¸Šé¢æåˆ°çš„â€œç»¿è‰²çº¿ç¨‹â€ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸Šå¯ä»¥è¿è¡Œæˆåƒä¸Šä¸‡ä¸ªåç¨‹
- Kotlin åç¨‹ï¼Œæ˜¯ç”¨æˆ·æ€çš„(userlevel)ï¼Œå†…æ ¸å¯¹åç¨‹**ã€Œæ— æ„ŸçŸ¥ã€**
- Kotlin åç¨‹ï¼Œæ˜¯åä½œå¼çš„ï¼Œç”±å¼€å‘è€…ç®¡ç†ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦å’Œåˆ‡æ¢ï¼Œä¹Ÿæ²¡æœ‰æŠ¢å å¼çš„æ¶ˆè€—ï¼Œå› æ­¤å®ƒæ›´åŠ **ã€Œé«˜æ•ˆã€**
- Kotlin åç¨‹ï¼Œå®ƒåº•å±‚åŸºäºçŠ¶æ€æœºå®ç°ï¼Œå¤šåç¨‹ä¹‹é—´å…±ç”¨ä¸€ä¸ªå®ä¾‹ï¼Œèµ„æºå¼€é”€æå°ï¼Œå› æ­¤å®ƒæ›´åŠ **ã€Œè½»é‡ã€**
- Kotlin åç¨‹ï¼Œæœ¬è´¨è¿˜æ˜¯è¿è¡Œäºçº¿ç¨‹ä¹‹ä¸Šï¼Œå®ƒé€šè¿‡åç¨‹è°ƒåº¦å™¨ï¼Œå¯ä»¥è¿è¡Œåˆ°ä¸åŒçš„çº¿ç¨‹ä¸Š

æŒ‚èµ·å‡½æ•°æ˜¯ Kotlin åç¨‹æœ€å…³é”®çš„å†…å®¹ï¼Œä¸€å®šè¦ç†è§£é€å½»ã€‚

æ–‡ä¸­æ‰€æœ‰ä»£ç éƒ½å·²åœ¨ Demo ä¸­æä¾›ï¼Œçœ‹å®Œæ–‡ç« ä»¥åï¼Œä½ ä¸€å®šä¼šæœ‰ä¸å°‘ç–‘æƒ‘ï¼Œä¸€å®šè¦å»å®é™…è°ƒè¯•è¿è¡Œ[^4]ã€‚

## 10. é¸£è°¢

æ„Ÿè°¢ä»¥ä¸‹å‡ ä½å¤§ä½¬åœ¨æœ¬æ–‡åˆ›ä½œè¿‡ç¨‹å½“ä¸­ç»™å‡ºçš„å¸®åŠ©å’Œè‚¯å®šï¼š

**Benny Huo**ï¼šç»´æŠ¤ Kotlin å¾®ä¿¡å…¬ä¼—å·ï¼Œè‘—æœ‰ã€Šæ·±å…¥ç†è§£Kotlin åç¨‹ã€‹ï¼Œè¯¥ä¹¦å¯¹æœ¬æ–‡æœ‰æå¤§å¯å‘ã€‚

**é™ˆç¦**ï¼šæºç¨‹ç ”å‘æ€»ç›‘ï¼ŒKotlin è·¨å¹³å°é¢†åŸŸæŠ€æœ¯åˆ›æ–°å¼•é¢†è€…ã€‚

**æ®µå»ºå**ï¼šAndroid ç•ŒçŸ¥ååšä¸»â€œæŠ€æœ¯å°é»‘å±‹â€œã€‚

**éƒ­éœ–**ï¼šã€ŠAndroid ç¬¬ä¸€è¡Œä»£ç ã€‹ä½œè€…ï¼Œè°·æ­Œè®¤è¯çš„ GDEã€‚

**ä¹”ç¦¹æ˜‚**ï¼šã€ŠKotlin ç¼–ç¨‹å®è·µã€‹è¯‘è€…ï¼ŒKotlin åç¨‹ä¸­æ–‡æ–‡æ¡£è¯‘è€…ã€‚

**æ‰”ç‰©çº¿(æœ±å‡¯)**ï¼šè°·æ­Œè®¤è¯çš„ "Android å¼€å‘è€…ä¸“å®¶(GDE)"ï¼ŒHenCoder å‘èµ·äººã€‚

ä»¥ä¸Šæ’åéƒ¨åˆ†å…ˆåï¼Œé»˜è®¤é¦–å­—æ¯æ’åºã€‚

### Reference

[^1]:[https://github.com/chaxiu/KotlinJetpackInAction](https://github.com/chaxiu/KotlinJetpackInAction)

[^2]:[https://dictionary.cambridge.org/zhs/%E8%AF%8D%E5%85%B8/%E8%8B%B1%E8%AF%AD/continuation](https://dictionary.cambridge.org/zhs/%E8%AF%8D%E5%85%B8/%E8%8B%B1%E8%AF%AD/continuation)

[^3]:[https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E7%BB%AD%E4%BD%93](https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E7%BB%AD%E4%BD%93)

[^4]:https://github.com/chaxiu/KotlinJetpackInAction

[^5]:[Kotlin Jetpack å®æˆ˜ï¼šå›¾è§£åç¨‹åŸç†](https://mp.weixin.qq.com/s/7nAs1T4hh_lGpEEEYjTVDg)

---

### ä¸ªäººç†è§£

Kotlin çš„åç¨‹ï¼Œæ ¸å¿ƒåœ¨äºå…¶å†…éƒ¨æ–°å®šä¹‰å®ç°çš„*å•ä¾‹* å­ç±» `ContinuationImpl`ï¼Œæœ¬è´¨ä¸º CPS + çŠ¶æ€æœºï¼Œæ ¸å¿ƒä½¿å¾—æœ¬è´¨è¿è¡Œã€‚

`ContinuationImpl` å®ç°äº†å¯¹çŠ¶æ€æœºçš„çŠ¶æ€çš„æ ‡è¯†ï¼Œ`invokeSuspend()` å›è°ƒå‡½æ•°å¯¹ `CPS`(`this`) çš„å›è°ƒã€‚

å¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š

1. å¯¹å„æŒ‚èµ·å‡½æ•° ( `suspend` ä¿®é¥° ) è¿›è¡Œ `CPSè½¬æ¢` ( `Continuation-Passing-Style Transformation` ) 

2. ä¸º continuation å‚æ•°èµ‹å€¼ï¼Œå¦‚æœè¯¥å€¼ä¸º `ContinuationImpl` ç±»å‹ï¼Œåˆ™å»¶ç”¨è¯¥ç±»ï¼Œå¦åˆ™è°ƒç”¨å®šä¹‰çš„å­ç±» `ContinuationImpl` è¿›è¡ŒåŒ…è£… ( ä¸€èˆ¬åªè¦åœ¨åˆæ¬¡èµ‹å€¼åŒ…è£… )ã€‚
3. è¿›å…¥ `whe(continuation.label){ x -> {}}` çŠ¶æ€æœºåˆ¤æ–­ï¼Œæ›´æ–°çŠ¶æ€æ ‡è®° `label` å¹¶è°ƒç”¨**IOçº¿ç¨‹**æ‰§è¡ŒæŒ‚èµ·å‡½æ•°ä½“ï¼Œå…¶ä¸­æŒ‚èµ·å‡½æ•° `withContext(Dispatchers.IO){ x }` çš„è°ƒç”¨å°†ç›´æ¥è¿”å› **æŒ‚èµ·çŠ¶æ€ç **ï¼ŒçŠ¶æ€æœºçŠ¶æ€æœºæ£€æµ‹åˆ°è¯¥å€¼åï¼Œå°†å“åº”æŒ‚èµ·å‡½æ•°çš„å›è°ƒã€‚
4. è‹¥åŠ å…¥ `suspend` ä¿®é¥°çš„å‡½æ•°ä¸­ä¸åŒ…å« `withContext(Dispatchers.IO){ x }` å®ç°æŒ‚èµ·è¿›ç¨‹ï¼Œåˆ™è¯¥å‡½æ•°ä¸º**ä¼ªå‡½æ•°**ï¼ŒçŠ¶æ€æœºå°†åˆ¤æ–­å…¶æœªè¿›å…¥æŒ‚èµ·çŠ¶æ€ï¼Œé€šè¿‡è·³è½¬åˆ° `when` å‰çš„ `label` èµ‹å€¼è¿›å…¥ä¸‹ä¸€çŠ¶æ€ï¼Œä¹Ÿå³è¯¥å‡½æ•°è¿˜æ˜¯åœ¨**ä¸»çº¿ç¨‹**å®Œæˆçš„ã€‚
5. å¾ªç¯å¾€å¤ï¼Œç›´è‡³åˆ°è¾¾æœ€ç»ˆçŠ¶æ€ä¸ºæ­¢ã€‚



